---
title: "Analysis Of Hockey Plus-Minus Using Linear Regression"
author: "Maxwell Brown"
date: "12/4/2017"
output: pdf_document
fontsize: 12pt
geometry: margin =1in

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rmutil)
library(tidyverse)
library(stats4)
library(knitr)
library(broom)
library(ggplot2)
library(GGally)
```

```{r echo=FALSE}
data <- read.csv("2007-2017.csv")
data_PP <- read.csv("2007-2017_PP.csv")
#create row names 
rownames(data) <- (data$Player)

```

```{r echo=FALSE}
playerID = match(row.names(data), data_PP$Player)
data$PP_G = data_PP$G[playerID]
data$PP_A = data_PP$A[playerID]
data$PP_G...=data_PP$G...[playerID]
data$PP_GA=data_PP$GA[playerID]
data$PP_GF=data_PP$GF[playerID]
```


```{r echo=FALSE, message=FALSE}
####Adding salary and Position 
#import salary data 
salary <- read_csv("~/Documents/BU/MA 681/Final Project /names.csv", 
    col_names = FALSE)
playerID = match(row.names(data), salary$X1)
data$Salary = salary$X2[playerID]
#make values numbers 
data$Salary = as.numeric(data$Salary)

#seperate Defence from Forwards 
Defence <- read_csv("~/Documents/BU/MA 681/Final Project /NEW/Defence .csv")
##create new column that holds D
Defence$Pos = rep('Defence',length(Defence$Player))
playerID = match(row.names(data), Defence$Player)
data$Pos = Defence$Pos[playerID]
#Identify the forwards 
data$Pos[is.na(data$Pos)] <- 'Forward'
new = subset(data, !is.na(data$Salary))
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=4, fig.height=3}
#plus-minus box plot by position 
#ggplot(new,aes(x= Pos,y= G...))+
#  geom_boxplot()+
#  ggtitle("Plus-Minus Distribution By Position")+ xlab("Position") + ylab("Plus-Minus")
#summary(new$G...)

ggplot(new,aes(G..., colour = Pos, fill = Pos))+
  geom_density(alpha = 0.1)+
  ggtitle("Plus-Minus Distribution By Position")+ xlab("Plus-Minus") + ylab("Distribution")
```


**Abstract**  

  In the hockey, plus-minus is one of the most utilized player statistic. Although it is so frequently used to evaluate players impact on the game, plus-minus receives a great amount of criticism because it does not accurately portray players true potential because of its simplicity. This paper looks to analyze plus-minus and determine whether it is indicative of player worth and what other stats might influence plus-minus. 

**Introduction**  

  The ability to evaluate a player's potential or impact has always been a challenge in sports. Plus-minus is one of the oldest and most popularly used statistic in ice hockey. This is widely used to help determine players quality and impact on the ice, both offensively and defensively. What makes plus-minus an attractive stat is its  logic and simplicity. It acts as the measurement of the goal differential of a specific player when he or she is on the ice. Players are awarded a plus when they are on the ice and their team scores a goal, and players receives a minus when they are on the ice when the opposing team scores. This is a way to determine how a player performs on both ends of the ice. The basic idea is that a player with a higher plus-minus generates more offense as well as preventing scores against their team while on the ice. A negative plus-minus demonstrates a player with both weak offensive and defensive abilities. Nevertheless, plus-minus is subject to a great amount of noise, largely because of its simplicity. This noise comes from the fact that plus-minus does not take into effect a number of variables: other players on the ice, percent time, player positions, and non-scoring factors (Gramacy et al. 2013). As we progress in our ability to collect and store more data, new hockey stats like corsi are appearing and slowly gaining interest. Previous studies have also made attempts to improve plus-minus through linear or logistic regressions (Macdonald 2012)
  Although player value is difficult to measure in most sports, salary is a common way to interpret individual player’s worth (Gramacy et al. 2013, Smith 2012). This paper analyzes plus-minus by determine how it relates to players worth through linear regression. This paper also attempts to addresses what non scoring stats might help predict plus-minus through linear regression. 

**Data**

  NHL player data from 2008 to 2017 used in this analysis was downloaded from corsica.hockey. Player’s salary data was scraped from spotrac.com. Data cleaning was performed, matching player names between several datasets in order to combine them and create a summary report for each player. Players with fewer than 50 time-on-ice minutes were removed from the data, as these players will not provide any useful information because of there little to no playing time over a large span of 9 seasons. The data set contains a total of 667 NHL players. The plus-minus data being used incorporates even-strength, power play, short-handed, and overtime scoring events. The NHL excludes powerplay form player plus-minus, but to better understand player's ability, powerplay information is included. A player's total plus-minus is the sum of their plus-minus for each year while in the NHL from 2008 to 2017. Player’s plus-minus per game is their total plus-minus divided by the number of games that player has played. Total salary is the amount of money a player had accrued while playing within 2008 and 2017 seasons. The large amount of data, over the span of 9 years, was used to to ensure greater accuracy in player performance by decreasing variations that occur in short time frames. Player salary is not determined by a single season, therefore data over a greater amount of seasons will reflect why the player received higher salary.

**Methods**

  A scatter plot was created in order to visualize the relationship between plus-minus and player salary (Fig. 2). The data was grouped by position and the salary was set to a log scale to visualize this relationship better. The scatter plot showed a positive association between salary and plus-minus. To further understand this relationship, the following linear regression model to predict the accumulated plus-minus:

$Accumulated PlusMinus =\beta_0+\beta_1\times Salary+\beta_2 \times Position + \epsilon$

  For this linear model the dependent variable is accumulated plus-minus while coefficients are position and salary. Akaike’s Information Index was used in order to select the model that best fit the data. This linear model was overlaid along with the observed data in figure 1. Given the summary data in Table 1 for the linear model, all the coefficients are significant, and position and salary having positive impacts on plus-minus (Fig.2, Table 1). Figure 2 shows the residuals from the linear model plotted against accumulated plus-minus. These residuals show a linear trend, revealing that the model overestimates for plus-minus above zero and underestimates below zero. 

  A second scatter plot was created to visualize the relationship between plus-minus per game and salary (Fig. 3). Again salary is set to a log scale. There is a slight positive relationship between plus-minus per game and salary. A linear model was created to predict plus-minus per game using position and salary as coefficients.



```{r echo=FALSE}
##linearmodel with Position 
lm_Pos = lm(G...~ Pos + Salary,data=new)
```

```{r echo=FALSE, message = FALSE, warning=FALSE}
library(stringr)
#Plot positions and linear model 

#be able to fit the predicted values 
pred = data.frame(G... = predict(lm_Pos))
playerID = match(row.names(pred), new$Player)
pred$Salary = new$Salary[playerID]
pred$Pos = new$Pos[playerID]
#plot 

caption = "Figure 1: Scatter plot of players accumulated plus-minus form 2008 to 2017 vs accumulated player salary, catagorized by positoin. The linear regression model is overlaid on the data, again catagorized by position"

ggplot(data,aes(x=Salary, y=G..., color = Pos))+
  geom_point()+
  #geom_line(data=B)+
  ggtitle("Career Plus-Minus vs Salary By Position")+ xlab("Salary") + ylab("PM")+
  scale_x_log10()+
  geom_line(data=pred)+
  ggtitle("Accumulated Plus-Minus vs Salary")+ xlab("Player Salary") + ylab("Accumulated Plus-Minus")+
  labs(caption = str_wrap(caption,120))+theme(plot.caption=element_text(size=9, hjust=0, margin=margin(t=15)))
  
```


```{r, echo=FALSE, fig.width=6, fig.height=4}
#summary(lm_Pos)
plot(x=log(new$Salary),y=resid(lm_Pos), main="Residules vs plus-minus",sub="Figure 2: Residules for the linear model against the log scaled salary", xlab = "Salary", ylab = "Residules")
#plot(density(resid(lm_Pos))) # density distribution, clearly more higher negative residules 
#want to look more uniform 
#how to deal wwith skew regression coefi
#AIC(lm_Pos) #AIC decreases 

#overestimating for valuse above 0 +-
```

```{r echo=FALSE, results="asis", message=FALSE, warning=FALSE}
lm_Pos %>% tidy(conf.int = TRUE) %>% knitr::kable(digits = 100, col.names = c("Terms", "Estimates", "Std Error","Wald Statistic","P-Value",".05 Confidence", ".95 Confidence"), caption = "Summary statistics for linear regression to predict accumulated plus-minus")
```

A second scatter plot was created to visualize the relationship between plus-minus per game and salary (Fig 3). Again salary is set to a log scale. There is a slight positive relationship between plus-minus per game and salary. A linear model was created to predict plus-minus per game using position and salary as coefficients.

$Average PlusMinus Per Game =\beta_0+\beta_1\times Salary+\beta_2 \times Position + \epsilon$




```{r echo=FALSE, fig.width=4, fig.height=3}
################## +/- per game 
#create +/- per game data
data$G...game = data$G.../data$GP
new = subset(data, !is.na(data$Salary))

#plus-minus box plot by position 
#ggplot(data,aes(x= Pos,y= G...game))+
#  geom_boxplot()

ggplot(new,aes(G...game, colour = Pos, fill = Pos))+
  geom_density(alpha = 0.1)+
  ggtitle("Plus-Minus Distribution By Position")+ xlab("Plus-Minus") + ylab("Distribution")

```

```{r echo=FALSE, fig.width=4, fig.height=3}
#linear model 
lm_Pos_game = lm(G...game~Pos+Salary,data=new)

#Pos<-c(rep('Forward',2),rep('Defence',2))
#C = data.frame(Salary=rep(range(data$Salary,na.rm = TRUE),2),Pos)
#C$G...game <- predict.lm(lm_Pos_game,C)

#summary(lm_Pos_game)
#plot(x=new$G...game,y=resid(lm_Pos_game)) 
#plot(density(resid(lm_Pos_game)))
#AIC(lm_Pos)
#AIC(lm_Pos_game)
```

```{r echo=FALSE, message=FALSE}
#salary vs +/-

playerID = match(row.names(pred), new$Player)
pred$G...game = predict(lm_Pos_game)

caption = "Figure 3: Scatter plot of players average plus-minus form 2008 to 2017 vs accumulated player salary, catagorized by positoin. The linear regression model is overlaid on the data, again catagorized by position"

library(stringr)
ggplot(new, aes(x= Salary, y= G...game, color= Pos))+
  geom_point()+
  #geom_line(data = C)+
  scale_x_log10()+
  geom_line(data=pred)+
  ggtitle("Average Plus-Minus Per Game vs Salary")+ xlab("Player Salary") + ylab("Average Plus-Minus Per Game")+
  labs(caption = str_wrap(caption,120))+theme(plot.caption=element_text(size=9, hjust=0, margin=margin(t=15)))
```

```{r echo=FALSE, fig.width=6, fig.height=4}
plot(x=new$Salary,y=resid(lm_Pos_game),main="Residules vs Plus-Minus Per Game",sub="Figure 4: Residules for the linear model against the average plus-minus per game", xlab = "Average Plus-Minus", ylab = "Residules") 
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
tidy(lm_Pos_game, conf.int = TRUE) %>% knitr::kable(digits = 100, col.names = c("Terms", "Estimates", "Std Error","Wald Statistic","P-Value",".05 Confidence", ".95 Confidence"), caption = "Summary statistics for linear regression to predict average plus-minus per game")
```


  This model was overlaid on observed data in Figure 3. The plotted residuals in Figure 4 show that the model is overestimates for plus-minus per game above zero and underestimates below zero, similar to Figure 2. The linear model summary statistic table shows significance for both salary and position coefficients. The coefficients show for that position and salary have positive impacts on salary. 
  
  Plus-minus is commonly criticized because of its simplicity and not taking non scoring factors into account. To better understand what variables affect plus-minus, a linear regression model was created to predict accumulated player plus-minus based on non-scoring related statistics. Figure 5 is a pairwise plot categorized by position (forward in blue, defence in red) containing accumulated player plus-minus and the non scoring related statistics; games played, penalty plus-minus, time on ice percentage, zone start ratio and position. The correlations among the coefficient variables are relatively low, with the exception of salary vs games played. Forward selection and Akaike’s Information Index was used to help select the variables that would produce and effective linear model. The most effective model came from using Zone start ratio and games played: 

$Accumulated PlusMinus =\beta_0+\beta_1\times Zone StartRatio+\beta_2 \times GamesPlayed + \epsilon$



```{r, echo=FALSE, message=FALSE, warning=FALSE}
#### new variables, non scorign related 

pairing = data.frame('Plus_Minus'=new$G...,'Games.Played'=new$GP, 'Penalty.Plus_Minus'= new$iP...,'Time.On.Ice' = new$TOI., 'Zone.Start.Ratio'=new$ZSR, Salary = log10(new$Salary), Pos = new$Pos)
 
           
#testing = data.frame(scale(pairing[1:5]))
#testing = bind_cols(testing, Pos = new$Pos)
#testing = bind_cols(testing, Salary = log10(new$Salary))
caption = "Figure 5: Pairwise plot of accumulated player plus-minus and non scoring statistical measurments including: Games Played, Peantly Plus-Minus, Percentage Time On Ice, Zone Start Ratio, Salary, and Position. The data is catagorized by player position. The diagnal is the density plots, the lower triangular are the scatterplots, the upper trianglular are the correlations and correlations by position."
ggpairs(pairing,aes(colour=Pos))+
  ggtitle("Parwise Plot Of Non Scoring Variables")+
  labs(caption = str_wrap(caption,120))+theme(plot.caption=element_text(size=9, hjust=0, margin=margin(t=15)))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=4}
#install.packages('pander')
library(pander)
oh_boy2 = lm(Plus_Minus ~ Zone.Start.Ratio + Games.Played,pairing)
#summary(oh_boy2)
plot(x=new$G...game,y=resid(oh_boy2), main="Residules vs Plus-Minus Per Game",sub="Figure 4: Residules for the linear model against the accumulated plus-minus per game", xlab = "Accumulated Plus-Minus", ylab = "Residules")

tidy(oh_boy2, conf.int = TRUE) %>% knitr::kable(digits = 100, col.names = c("Terms", "Estimates", "Std Error","Wald Statistic","P-Value",".05 Confidence", ".95 Confidence"), caption = "Summary statistics for linear regression to predict accumulated plus-minus using non scoring stats")
#oh_boy2

```

**Discussion**
  
  Using NHL player salary as a way to value player’s worth, and comparing this with both accumulated plus-minus and average plus-minus per game, with respect to position, there is visible positive association (Fig. 1,3). These results are consistent with previous research that there is a positive relationship between player skills and plus-minus (Gramacy et al. 2013). Based on these trends, linear models were created to see how well plus-minus can be predicted from this data. This ability to predict plus-minus from player salary would prove how well plus-minus is indicative of player worth. Visually the predicted values for the linear model follow the trend of the data accurately. The salary and position coefficients for both models have significant p-values and are positive, therefore have a definite positive effect on player plus-minus (tabel 1,2). Between the two, the best model based on their summary statistics is the accumulated plus-minus predicting model.

  Although the linear models visually follows the data (Fig. 1,3) and the coefficients and overall linear model are found to be significant, based on the low R-squared values and residuals(Fig. 2, 4), these models are not the best models to estimate player plus-minus. The plotted residuals show that both models are under estimating for plus-minus that are below 0 and over estimating for plus-minus above 0. 
  
  When comparing player positions, the coefficients reveal that forwards are found to have a greater expected difference for both plus-minus stats (Fig. 1,2). This is due to the fact that defensemans plus-minuses do not show a strong linear trend when compared to salary, unlike forwards. What makes the defenceman appear less linear is the lack of relationship between salary and plus-minus for negative plus-minuses (Fig. 1,3). The difference in plus-minus between positions can most likely be explained by the difference in percent time on ice. Figure 5 shows that the greatest separation between positions occurs in percent time on ice. Defenceman accumulate a greater amount of time on ice because there are six defenceman and twelve forwards on a team. Time on ice does appear to be more correlated with plus-minus of forwards than of defenceman, most likely because the defenceman are playing with a greater number of forwards with different skill levels, and thus creating more variation in their plus-minus. Based on these differences between positions, plus-minus is a stronger representation of player performance for forwards than defenseman, and therefore can most likely be easier to predict using linear regression. 
  
  Because plus-minus is a scoring related measurement, plus-minus receives a lot of criticism because it does not reflect the non scoring events that occur. To address this issue, a multilinear regression model was created to assess whether career plus-minus could be estimated using non scoring variables. Based on the linear regression created in table 3, zone start ratio and games played are the most effective non scoring variables to predict career plus-minus. This makes sense that zone time ratio would predict plus-minus using linear regression. This makes sense as the table shows these variables are most correlated with career plus-minus. 
  
  Ideas for future analyses to address whether plus-minus is a good indicator of player impact, is to see how plus-minus per season compares with salary. Also a time series analysis of individual players plus-minus per season could shed light on how plus-minus varies along players careers. 


**Bibliography**


Gramacy, Robert B., Shane T. Jensen, and Matt Taddy. "Estimating player contribution in hockey with regularized logistic regression." Journal of Quantitative Analysis in Sports9.1 (2013): 97-111.

Smith, Gerald. "A Shot Quality Adjusted Plus-Minus For The NHL" Simon Fraser University (2016).

Macdonald, Brian. "Adjusted plus-minus for nhl players using ridge regression with goals, shots, fenwick, and corsi." Journal of Quantitative Analysis in Sports 8.3 (2012).